---
apiVersion: azure-devops
kind: BuildDefinition
metadata:
  labels:
    group: {{ .Values.group }}
    component: {{ .Release.Name }}
    type: CI
spec:
  name: {{ default .Release.Name .Values.build.name }}
  path: {{ .Values.build.path }}
  buildNumberFormat: {{ .Values.build.buildNameFormat }}
  triggers:
    - branchFilters:
{{ .Values.build.triggers.continuousIntegration.branchFilters | toYaml | indent 8 }}
      triggerType: 2
  variableGroups:
{{ .Values.build.variableGroups | toYaml | indent 4 }}
  process:
    phases:
      - steps:
          - displayName: Maven pom.xml
            task:
              id: ac4ee482-65da-4485-a532-7b085873e532 # TODO by name
              versionSpec: 3.*
              definitionType: task
            inputs:
              goals: clean deploy -U
              publishJUnitResults: 'false'
              jdkVersion: '{{ .Values.build.jdkVersion }}'
              mavenFeedAuthenticate: 'true'
          - displayName: 'Publish Artifact: k8s'
            task:
              id: 2ff763a7-ce83-4e1f-bc89-0ae63477cebe
              versionSpec: 1.*
              definitionType: task
            inputs:
              PathtoPublish: k8s
              ArtifactName: k8s
          - displayName: 'Task group: Publish api-definitions Artifact '
            task:
              id: 2793ff62-78af-4351-bdbc-03da6a37eda4
              versionSpec: 1.*
              definitionType: metaTask
          - displayName: 'Task group: Build and push Docker image to ALM Nexus'
            task:
              id: 001f6df6-2576-4520-ae2f-897b788a6017
              versionSpec: 1.*
              definitionType: metaTask
            inputs:
              build.arguments: ''
              docker.baseimage: {{ default "$(OPENJDK11_BASE_IMAGE)" .Values.build.baseImage }}
              dockerfile: ''
              image.name: {{ default .Release.Name .Values.build.imageName }}
  repository:
    id: {{ .Values.build.repository }}
  queue:
    id: {{ .Values.build.agentPool }}

