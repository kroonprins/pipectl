---
# Source: bll-common/templates/BuildPipeline-Nightly.yaml
apiVersion: azure-devops
kind: BuildDefinition
metadata:
  labels:
    group: bll
    component: bll-contracting
    type: nightly-build
spec:
  name: Test via API for bll-contracting Nightly
  path: \Other\POC\Nightly builds
  buildNumberFormat: $(SourceBranchName)_$(Date:yyyyMMdd)$(Rev:_r)
  triggers:
    - schedules:
        - branchFilters:
          - +refs/heads/master
          - +refs/heads/rc
          timeZoneId: Romance Standard Time
          startHours: 0
          startMinutes: 0
      triggerType: 8
  process:
    phases:
      - steps:
          - displayName: Prepare analysis on SonarQube
            task:
              id: 15b84ca1-b62f-4a2a-a403-89b77a063157
              versionSpec: 4.*
              definitionType: task
            inputs:
              SonarQube: 3866cf2d-2198-4655-b8f1-9fd6cedecac2
              scannerMode: Other
              configMode: file
              configFile: sonar-project.properties
              cliProjectKey: ''
              projectKey: ''
              cliProjectName: ''
              projectName: ''
              cliProjectVersion: '1.0'
              projectVersion: '1.0'
              cliSources: .
              extraProperties: |-
                # Additional properties that will be passed to the scanner,
                # Put one key=value per line, example:
                # sonar.exclusions=**/*.bin
                sonar.coverage.exclusions=**/resources/**
          - displayName: Maven pom.xml
            task:
              id: ac4ee482-65da-4485-a532-7b085873e532
              versionSpec: 3.*
              definitionType: task
            inputs:
              mavenPOMFile: pom.xml
              goals: clean package
              options: >-
                -Dmaven.test.failure.ignore=true -Drevision=$(Build.BuildNumber)
                -Dsonar.branch.name=
                -Dsonar.projectKey=com.electrabel.channels.web:bll-contracting:$(Build.SourceBranchName)
                -Dsonar.projectName="bll-contracting $(Build.SourceBranchName)"
              publishJUnitResults: 'true'
              testResultsFiles: '**/TEST-*.xml'
              codeCoverageTool: JaCoCo
              classFilter: '+:com.engie.*,-:*.resources.*'
              failIfCoverageEmpty: 'false'
              javaHomeSelection: JDKVersion
              jdkVersion: '1.11'
              mavenOpts: '-Xmx1024m'
              mavenFeedAuthenticate: 'true'
              skipEffectivePom: 'false'
              sqAnalysisEnabled: 'true'
              sqMavenPluginVersionChoice: latest
              checkstyleAnalysisEnabled: 'false'
              pmdAnalysisEnabled: 'false'
              findbugsAnalysisEnabled: 'false'
  repository:
    id: 6c68508f-62a2-4d9f-9707-9f2d2a418147
  queue:
    id: 43
---
# Source: bll-common/templates/BuildPipeline-Release-Client.yaml
apiVersion: azure-devops
kind: BuildDefinition
metadata:
  labels:
    group: bll
    component: bll-contracting
    type: release-client-build
spec:
  name: Test via API for bll-contracting Release
  path: \Other\POC
  buildNumberFormat: $(SourceBranchName)_$(Date:yyyyMMdd)$(Rev:_r)
  process:
    phases:
      - steps:
          - displayName: 'Task group: Maven release'
            task:
              id: b880882f-e197-4652-bfad-5510bd41908c
              versionSpec: 2.*
              definitionType: metaTask
  repository:
    id: 6c68508f-62a2-4d9f-9707-9f2d2a418147
  queue:
    id: 43
---
# Source: bll-common/templates/BuildPipeline.yaml
apiVersion: azure-devops
kind: BuildDefinition
metadata:
  labels:
    group: bll
    component: bll-contracting
    type: ci-build
spec:
  name: Test via API for bll-contracting
  path: \Other\POC
  buildNumberFormat: $(SourceBranchName)_$(Date:yyyyMMdd)$(Rev:_r)
  triggers:
    - branchFilters:
        - +refs/heads/rc*
        - +refs/heads/feature/*
        - +refs/heads/renovate/*
      triggerType: 2
  variableGroups:
    - Docker Builds
  process:
    phases:
      - steps:
          - displayName: Maven pom.xml
            task:
              id: ac4ee482-65da-4485-a532-7b085873e532 # TODO by name
              versionSpec: 3.*
              definitionType: task
            inputs:
              goals: clean deploy -U
              publishJUnitResults: 'false'
              jdkVersion: '1.11'
              mavenFeedAuthenticate: 'true'
          - displayName: 'Publish Artifact: k8s'
            task:
              id: 2ff763a7-ce83-4e1f-bc89-0ae63477cebe
              versionSpec: 1.*
              definitionType: task
            inputs:
              PathtoPublish: k8s
              ArtifactName: k8s
          - displayName: 'Task group: Publish api-definitions Artifact '
            task:
              id: 2793ff62-78af-4351-bdbc-03da6a37eda4
              versionSpec: 1.*
              definitionType: metaTask
          - displayName: 'Task group: Build and push Docker image to ALM Nexus'
            task:
              id: 001f6df6-2576-4520-ae2f-897b788a6017
              versionSpec: 1.*
              definitionType: metaTask
            inputs:
              build.arguments: ''
              docker.baseimage: $(OPENJDK11_BASE_IMAGE)
              dockerfile: ''
              image.name: bll-contracting
  repository:
    id: 6c68508f-62a2-4d9f-9707-9f2d2a418147
  queue:
    id: 43
---
# Source: bll-common/templates/ReleaseDefinition.yaml
apiVersion: azure-devops/v0.1
kind: ReleaseDefinition
metadata:
  labels:
    group: bll
    component: bll-contracting
spec:
  name: Test via API for bll-contracting
  path: \Other\POC
  description: Created via script
  releaseNameFormat: Release-$(rev:r)
  variables:
    BLL_DO_AUDITING:
      value: do_uda
    BLL_LOG_LEVEL:
      value: INFO
    K8S_AGENT_POOL:
      value: general
    K8S_NAMESPACE:
      value: core
    REPLICAS:
      value: 2
    ROOT_LOG_LEVEL:
      value: INFO
    
    RABBITMQ_USERNAME:
      value: bll-contracting
    
  environments:
  - name: INT-WE
    retentionPolicy:
      releasesToKeep: 10
    variables:
      BLL_LOG_LEVEL:
        value: DEBUG
    variableGroups:
    - Config INT
    - Config INT-WE
    deployPhases:
    - name: Agent phase
      deploymentInput:
        queueId: 165
      workflowTasks:
      - taskId: 1e244d32-2dd4-4165-96fb-b7441ca9331e
        version: 1.*
        name: 'Azure Key Vault: webfoundation-int-akv'
        definitionType: task
        inputs:
          ConnectedServiceName: 6714e6c3-6518-4050-90ec-ed7288c13b3a
          KeyVaultName: webfoundation-int-akv
          SecretsFilter: "*"
      - taskId: 93a67d85-4982-4e19-87dd-29311c974748
        version: 2.*
        name: 'Task group: Create RabbitMQ user'
        definitionType: metaTask
        inputs:
          AksCluster: "$(AKS_CLUSTER)"
          AzureResourceGroup: "$(AZURE_RESOURCE_GROUP)"
          AzureSubscription: 6714e6c3-6518-4050-90ec-ed7288c13b3a
          KubernetesNamespace: "$(K8S_NAMESPACE)"
          RabbitMQPassword: "$(rabbitmq-bll-contracting-password)"
          RabbitMQPod: ''
          RabbitMQUsername: "$(RABBITMQ_USERNAME)"
          RabbitMQVirtualHost: ''
      - taskId: 76a92167-7c70-4b54-ba35-13d5819c9b1e
        version: 2.*
        name: 'Task group: K8S Deploy V3 bll-contracting'
        definitionType: metaTask
        inputs:
          AksCluster: "$(AKS_CLUSTER)"
          AzureResourceGroup: "$(AZURE_RESOURCE_GROUP)"
          AzureSubscription: 6714e6c3-6518-4050-90ec-ed7288c13b3a
          HelmArtifact: ''
          KubernetesDeploymentName: bll-contracting
          KubernetesNamespace: "$(K8S_NAMESPACE)"
          KubernetesObjectType: ''
          SecretValues: RABBITMQ_PASSWORD=$(rabbitmq-bll-contracting-password),ESB_KEYSTORE_PW=$(esb-ihn519-password),ESB_KEYSTORE_FILE=$(esb-ihn519-value),BLL_JWKS_ENCRYPTION=$(bll-jwks-encryption),BLL_JWKS_SIGNATURE=$(bll-jwks-signature)
    
    
  - name: INT-NE
    retentionPolicy:
      releasesToKeep: 10
    variables:
      BLL_LOG_LEVEL:
        value: DEBUG
    variableGroups:
    - Config INT
    - Config INT-NE
    deployPhases:
    - name: Agent phase
      deploymentInput:
        queueId: 164
      workflowTasks:
      - taskId: 1e244d32-2dd4-4165-96fb-b7441ca9331e
        version: 1.*
        name: 'Azure Key Vault: webfoundation-int-akv'
        definitionType: task
        inputs:
          ConnectedServiceName: 6714e6c3-6518-4050-90ec-ed7288c13b3a
          KeyVaultName: webfoundation-int-akv
          SecretsFilter: "*"
      - taskId: 93a67d85-4982-4e19-87dd-29311c974748
        version: 2.*
        name: 'Task group: Create RabbitMQ user'
        definitionType: metaTask
        inputs:
          AksCluster: "$(AKS_CLUSTER)"
          AzureResourceGroup: "$(AZURE_RESOURCE_GROUP)"
          AzureSubscription: 6714e6c3-6518-4050-90ec-ed7288c13b3a
          KubernetesNamespace: "$(K8S_NAMESPACE)"
          RabbitMQPassword: "$(rabbitmq-bll-contracting-password)"
          RabbitMQPod: ''
          RabbitMQUsername: "$(RABBITMQ_USERNAME)"
          RabbitMQVirtualHost: ''
      - taskId: 76a92167-7c70-4b54-ba35-13d5819c9b1e
        version: 2.*
        name: 'Task group: K8S Deploy V3 bll-contracting'
        definitionType: metaTask
        inputs:
          AksCluster: "$(AKS_CLUSTER)"
          AzureResourceGroup: "$(AZURE_RESOURCE_GROUP)"
          AzureSubscription: 6714e6c3-6518-4050-90ec-ed7288c13b3a
          HelmArtifact: ''
          KubernetesDeploymentName: bll-contracting
          KubernetesNamespace: "$(K8S_NAMESPACE)"
          KubernetesObjectType: ''
          SecretValues: RABBITMQ_PASSWORD=$(rabbitmq-bll-contracting-password),ESB_KEYSTORE_PW=$(esb-ihn519-password),ESB_KEYSTORE_FILE=$(esb-ihn519-value),BLL_JWKS_ENCRYPTION=$(bll-jwks-encryption),BLL_JWKS_SIGNATURE=$(bll-jwks-signature)
    
    
  - name: ACC-WE
    retentionPolicy:
      releasesToKeep: 10
    variables:
      BLL_LOG_LEVEL:
        value: DEBUG
    variableGroups:
    - Config INT
    - Config INT-WE
    deployPhases:
    - name: Agent phase
      deploymentInput:
        queueId: 165
      workflowTasks:
      - taskId: 1e244d32-2dd4-4165-96fb-b7441ca9331e
        version: 1.*
        name: 'Azure Key Vault: webfoundation-acc-akv'
        definitionType: task
        inputs:
          ConnectedServiceName: 6714e6c3-6518-4050-90ec-ed7288c13b3a
          KeyVaultName: webfoundation-acc-akv
          SecretsFilter: "*"
      - taskId: 93a67d85-4982-4e19-87dd-29311c974748
        version: 2.*
        name: 'Task group: Create RabbitMQ user'
        definitionType: metaTask
        inputs:
          AksCluster: "$(AKS_CLUSTER)"
          AzureResourceGroup: "$(AZURE_RESOURCE_GROUP)"
          AzureSubscription: 6714e6c3-6518-4050-90ec-ed7288c13b3a
          KubernetesNamespace: "$(K8S_NAMESPACE)"
          RabbitMQPassword: "$(rabbitmq-bll-contracting-password)"
          RabbitMQPod: ''
          RabbitMQUsername: "$(RABBITMQ_USERNAME)"
          RabbitMQVirtualHost: ''
      - taskId: 76a92167-7c70-4b54-ba35-13d5819c9b1e
        version: 2.*
        name: 'Task group: K8S Deploy V3 bll-contracting'
        definitionType: metaTask
        inputs:
          AksCluster: "$(AKS_CLUSTER)"
          AzureResourceGroup: "$(AZURE_RESOURCE_GROUP)"
          AzureSubscription: 6714e6c3-6518-4050-90ec-ed7288c13b3a
          HelmArtifact: ''
          KubernetesDeploymentName: bll-contracting
          KubernetesNamespace: "$(K8S_NAMESPACE)"
          KubernetesObjectType: ''
          SecretValues: RABBITMQ_PASSWORD=$(rabbitmq-bll-contracting-password),ESB_KEYSTORE_PW=$(esb-hhn544-password),ESB_KEYSTORE_FILE=$(esb-hhn544-value),BLL_JWKS_ENCRYPTION=$(bll-jwks-encryption),BLL_JWKS_SIGNATURE=$(bll-jwks-signature)
    preDeployApprovals:
      approvals:
      - approver:
          id: c48d7901-feca-403b-b698-cf99c6e7d602
          isContainer: true
      approvalOptions:
        releaseCreatorCanBeApprover: true
    
  - name: ACC-NE
    retentionPolicy:
      releasesToKeep: 10
    variableGroups:
    - Config INT
    - Config INT-NE
    deployPhases:
    - name: Agent phase
      deploymentInput:
        queueId: 164
      workflowTasks:
      - taskId: 1e244d32-2dd4-4165-96fb-b7441ca9331e
        version: 1.*
        name: 'Azure Key Vault: webfoundation-acc-akv'
        definitionType: task
        inputs:
          ConnectedServiceName: 6714e6c3-6518-4050-90ec-ed7288c13b3a
          KeyVaultName: webfoundation-acc-akv
          SecretsFilter: "*"
      - taskId: 93a67d85-4982-4e19-87dd-29311c974748
        version: 2.*
        name: 'Task group: Create RabbitMQ user'
        definitionType: metaTask
        inputs:
          AksCluster: "$(AKS_CLUSTER)"
          AzureResourceGroup: "$(AZURE_RESOURCE_GROUP)"
          AzureSubscription: 6714e6c3-6518-4050-90ec-ed7288c13b3a
          KubernetesNamespace: "$(K8S_NAMESPACE)"
          RabbitMQPassword: "$(rabbitmq-bll-contracting-password)"
          RabbitMQPod: ''
          RabbitMQUsername: "$(RABBITMQ_USERNAME)"
          RabbitMQVirtualHost: ''
      - taskId: 76a92167-7c70-4b54-ba35-13d5819c9b1e
        version: 2.*
        name: 'Task group: K8S Deploy V3 bll-contracting'
        definitionType: metaTask
        inputs:
          AksCluster: "$(AKS_CLUSTER)"
          AzureResourceGroup: "$(AZURE_RESOURCE_GROUP)"
          AzureSubscription: 6714e6c3-6518-4050-90ec-ed7288c13b3a
          HelmArtifact: ''
          KubernetesDeploymentName: bll-contracting
          KubernetesNamespace: "$(K8S_NAMESPACE)"
          KubernetesObjectType: ''
          SecretValues: RABBITMQ_PASSWORD=$(rabbitmq-bll-contracting-password),ESB_KEYSTORE_PW=$(esb-hhn544-password),ESB_KEYSTORE_FILE=$(esb-hhn544-value),BLL_JWKS_ENCRYPTION=$(bll-jwks-encryption),BLL_JWKS_SIGNATURE=$(bll-jwks-signature)
    preDeployApprovals:
      approvals:
      - approver:
          id: c48d7901-feca-403b-b698-cf99c6e7d602
          isContainer: true
      approvalOptions:
        releaseCreatorCanBeApprover: true
    
  - name: PRD-WE
    retentionPolicy:
      releasesToKeep: 10
    variableGroups:
    - Config INT
    - Config INT-WE
    deployPhases:
    - name: Agent phase
      deploymentInput:
        queueId: 165
      workflowTasks:
      - taskId: 1e244d32-2dd4-4165-96fb-b7441ca9331e
        version: 1.*
        name: 'Azure Key Vault: webfoundation-prd-akv'
        definitionType: task
        inputs:
          ConnectedServiceName: 6714e6c3-6518-4050-90ec-ed7288c13b3a
          KeyVaultName: webfoundation-prd-akv
          SecretsFilter: "*"
      - taskId: 93a67d85-4982-4e19-87dd-29311c974748
        version: 2.*
        name: 'Task group: Create RabbitMQ user'
        definitionType: metaTask
        inputs:
          AksCluster: "$(AKS_CLUSTER)"
          AzureResourceGroup: "$(AZURE_RESOURCE_GROUP)"
          AzureSubscription: 6714e6c3-6518-4050-90ec-ed7288c13b3a
          KubernetesNamespace: "$(K8S_NAMESPACE)"
          RabbitMQPassword: "$(rabbitmq-bll-contracting-password)"
          RabbitMQPod: ''
          RabbitMQUsername: "$(RABBITMQ_USERNAME)"
          RabbitMQVirtualHost: ''
      - taskId: 76a92167-7c70-4b54-ba35-13d5819c9b1e
        version: 2.*
        name: 'Task group: K8S Deploy V3 bll-contracting'
        definitionType: metaTask
        inputs:
          AksCluster: "$(AKS_CLUSTER)"
          AzureResourceGroup: "$(AZURE_RESOURCE_GROUP)"
          AzureSubscription: 6714e6c3-6518-4050-90ec-ed7288c13b3a
          HelmArtifact: ''
          KubernetesDeploymentName: bll-contracting
          KubernetesNamespace: "$(K8S_NAMESPACE)"
          KubernetesObjectType: ''
          SecretValues: RABBITMQ_PASSWORD=$(rabbitmq-bll-contracting-password),ESB_KEYSTORE_PW=$(esb-gim597-password),ESB_KEYSTORE_FILE=$(esb-gim597-value),BLL_JWKS_ENCRYPTION=$(bll-jwks-encryption),BLL_JWKS_SIGNATURE=$(bll-jwks-signature)
    preDeployApprovals:
      approvals:
      - approver:
          id: e9a38fdf-a890-4227-909e-c438dc074464
          isContainer: true
      approvalOptions:
        releaseCreatorCanBeApprover: true
    
  - name: PRD-NE
    retentionPolicy:
      releasesToKeep: 10
    variableGroups:
    - Config INT
    - Config INT-NE
    deployPhases:
    - name: Agent phase
      deploymentInput:
        queueId: 164
      workflowTasks:
      - taskId: 1e244d32-2dd4-4165-96fb-b7441ca9331e
        version: 1.*
        name: 'Azure Key Vault: webfoundation-prd-akv'
        definitionType: task
        inputs:
          ConnectedServiceName: 6714e6c3-6518-4050-90ec-ed7288c13b3a
          KeyVaultName: webfoundation-prd-akv
          SecretsFilter: "*"
      - taskId: 93a67d85-4982-4e19-87dd-29311c974748
        version: 2.*
        name: 'Task group: Create RabbitMQ user'
        definitionType: metaTask
        inputs:
          AksCluster: "$(AKS_CLUSTER)"
          AzureResourceGroup: "$(AZURE_RESOURCE_GROUP)"
          AzureSubscription: 6714e6c3-6518-4050-90ec-ed7288c13b3a
          KubernetesNamespace: "$(K8S_NAMESPACE)"
          RabbitMQPassword: "$(rabbitmq-bll-contracting-password)"
          RabbitMQPod: ''
          RabbitMQUsername: "$(RABBITMQ_USERNAME)"
          RabbitMQVirtualHost: ''
      - taskId: 76a92167-7c70-4b54-ba35-13d5819c9b1e
        version: 2.*
        name: 'Task group: K8S Deploy V3 bll-contracting'
        definitionType: metaTask
        inputs:
          AksCluster: "$(AKS_CLUSTER)"
          AzureResourceGroup: "$(AZURE_RESOURCE_GROUP)"
          AzureSubscription: 6714e6c3-6518-4050-90ec-ed7288c13b3a
          HelmArtifact: ''
          KubernetesDeploymentName: bll-contracting
          KubernetesNamespace: "$(K8S_NAMESPACE)"
          KubernetesObjectType: ''
          SecretValues: RABBITMQ_PASSWORD=$(rabbitmq-bll-contracting-password),ESB_KEYSTORE_PW=$(esb-gim597-password),ESB_KEYSTORE_FILE=$(esb-gim597-value),BLL_JWKS_ENCRYPTION=$(bll-jwks-encryption),BLL_JWKS_SIGNATURE=$(bll-jwks-signature)
    preDeployApprovals:
      approvals:
      - approver:
          id: e9a38fdf-a890-4227-909e-c438dc074464
          isContainer: true
      approvalOptions:
        releaseCreatorCanBeApprover: true
    
  artifacts:
  - type: Build
    alias: Test via API for bll-contracting
    definitionReference:
      defaultVersionType:
        id: latestType
        name: Latest
      definition:
        name: Test via API for bll-contracting
        path:  \Other\POC

---
# Source: bll-common/templates/BuildPipeline-Nightly.yaml
apiVersion: azure-devops
kind: BuildDefinition
metadata:
  labels:
    group: bll
    component: bll-contact
    type: nightly-build
spec:
  name: Test via API for bll-contact Nightly
  path: \Other\POC\Nightly builds
  buildNumberFormat: $(SourceBranchName)_$(Date:yyyyMMdd)$(Rev:_r)
  triggers:
    - schedules:
        - branchFilters:
          - +refs/heads/master
          - +refs/heads/rc
          timeZoneId: Romance Standard Time
          startHours: 0
          startMinutes: 0
      triggerType: 8
  process:
    phases:
      - steps:
          - displayName: Prepare analysis on SonarQube
            task:
              id: 15b84ca1-b62f-4a2a-a403-89b77a063157
              versionSpec: 4.*
              definitionType: task
            inputs:
              SonarQube: 3866cf2d-2198-4655-b8f1-9fd6cedecac2
              scannerMode: Other
              configMode: file
              configFile: sonar-project.properties
              cliProjectKey: ''
              projectKey: ''
              cliProjectName: ''
              projectName: ''
              cliProjectVersion: '1.0'
              projectVersion: '1.0'
              cliSources: .
              extraProperties: |-
                # Additional properties that will be passed to the scanner,
                # Put one key=value per line, example:
                # sonar.exclusions=**/*.bin
                sonar.coverage.exclusions=**/resources/**
          - displayName: Maven pom.xml
            task:
              id: ac4ee482-65da-4485-a532-7b085873e532
              versionSpec: 3.*
              definitionType: task
            inputs:
              mavenPOMFile: pom.xml
              goals: clean package
              options: >-
                -Dmaven.test.failure.ignore=true -Drevision=$(Build.BuildNumber)
                -Dsonar.branch.name=
                -Dsonar.projectKey=com.electrabel.channels.web:bll-contact:$(Build.SourceBranchName)
                -Dsonar.projectName="bll-contact $(Build.SourceBranchName)"
              publishJUnitResults: 'true'
              testResultsFiles: '**/TEST-*.xml'
              codeCoverageTool: JaCoCo
              classFilter: '+:com.engie.*,-:*.resources.*'
              failIfCoverageEmpty: 'false'
              javaHomeSelection: JDKVersion
              jdkVersion: '1.11'
              mavenOpts: '-Xmx1024m'
              mavenFeedAuthenticate: 'true'
              skipEffectivePom: 'false'
              sqAnalysisEnabled: 'true'
              sqMavenPluginVersionChoice: latest
              checkstyleAnalysisEnabled: 'false'
              pmdAnalysisEnabled: 'false'
              findbugsAnalysisEnabled: 'false'
  repository:
    id: 60f95ef8-bd9a-4ade-87b2-751753700cb3
  queue:
    id: 43
---
# Source: bll-common/templates/BuildPipeline-Release-Client.yaml
apiVersion: azure-devops
kind: BuildDefinition
metadata:
  labels:
    group: bll
    component: bll-contact
    type: release-client-build
spec:
  name: Test via API for bll-contact Release
  path: \Other\POC
  buildNumberFormat: $(SourceBranchName)_$(Date:yyyyMMdd)$(Rev:_r)
  process:
    phases:
      - steps:
          - displayName: 'Task group: Maven release'
            task:
              id: b880882f-e197-4652-bfad-5510bd41908c
              versionSpec: 2.*
              definitionType: metaTask
  repository:
    id: 60f95ef8-bd9a-4ade-87b2-751753700cb3
  queue:
    id: 43
---
# Source: bll-common/templates/BuildPipeline.yaml
apiVersion: azure-devops
kind: BuildDefinition
metadata:
  labels:
    group: bll
    component: bll-contact
    type: ci-build
spec:
  name: Test via API for bll-contact
  path: \Other\POC
  buildNumberFormat: $(SourceBranchName)_$(Date:yyyyMMdd)$(Rev:_r)
  triggers:
    - branchFilters:
        - +refs/heads/rc*
        - +refs/heads/feature/*
        - +refs/heads/renovate/*
      triggerType: 2
  variableGroups:
    - Docker Builds
  process:
    phases:
      - steps:
          - displayName: Maven pom.xml
            task:
              id: ac4ee482-65da-4485-a532-7b085873e532 # TODO by name
              versionSpec: 3.*
              definitionType: task
            inputs:
              goals: clean deploy -U
              publishJUnitResults: 'false'
              jdkVersion: '1.11'
              mavenFeedAuthenticate: 'true'
          - displayName: 'Publish Artifact: k8s'
            task:
              id: 2ff763a7-ce83-4e1f-bc89-0ae63477cebe
              versionSpec: 1.*
              definitionType: task
            inputs:
              PathtoPublish: k8s
              ArtifactName: k8s
          - displayName: 'Task group: Publish api-definitions Artifact '
            task:
              id: 2793ff62-78af-4351-bdbc-03da6a37eda4
              versionSpec: 1.*
              definitionType: metaTask
          - displayName: 'Task group: Build and push Docker image to ALM Nexus'
            task:
              id: 001f6df6-2576-4520-ae2f-897b788a6017
              versionSpec: 1.*
              definitionType: metaTask
            inputs:
              build.arguments: ''
              docker.baseimage: $(OPENJDK11_BASE_IMAGE)
              dockerfile: ''
              image.name: bll-contact
  repository:
    id: 60f95ef8-bd9a-4ade-87b2-751753700cb3
  queue:
    id: 43
---
# Source: bll-common/templates/ReleaseDefinition.yaml
apiVersion: azure-devops/v0.1
kind: ReleaseDefinition
metadata:
  labels:
    group: bll
    component: bll-contact
spec:
  name: Test via API for bll-contact
  path: \Other\POC
  description: Created via script
  releaseNameFormat: Release-$(rev:r)
  variables:
    BLL_LOG_LEVEL:
      value: INFO
    K8S_AGENT_POOL:
      value: general
    K8S_NAMESPACE:
      value: core
    REPLICAS:
      value: 2
    ROOT_LOG_LEVEL:
      value: INFO
    
    
  environments:
  - name: INT-WE
    retentionPolicy:
      releasesToKeep: 10
    variables:
      BLL_LOG_LEVEL:
        value: DEBUG
    variableGroups:
    - Config INT
    - Config INT-WE
    deployPhases:
    - name: Agent phase
      deploymentInput:
        queueId: 165
      workflowTasks:
      - taskId: 1e244d32-2dd4-4165-96fb-b7441ca9331e
        version: 1.*
        name: 'Azure Key Vault: webfoundation-int-akv'
        definitionType: task
        inputs:
          ConnectedServiceName: 6714e6c3-6518-4050-90ec-ed7288c13b3a
          KeyVaultName: webfoundation-int-akv
          SecretsFilter: "*"
      
      - taskId: 76a92167-7c70-4b54-ba35-13d5819c9b1e
        version: 2.*
        name: 'Task group: K8S Deploy V3 bll-contact'
        definitionType: metaTask
        inputs:
          AksCluster: "$(AKS_CLUSTER)"
          AzureResourceGroup: "$(AZURE_RESOURCE_GROUP)"
          AzureSubscription: 6714e6c3-6518-4050-90ec-ed7288c13b3a
          HelmArtifact: ''
          KubernetesDeploymentName: bll-contact
          KubernetesNamespace: "$(K8S_NAMESPACE)"
          KubernetesObjectType: ''
          SecretValues: BLL_JWKS_ENCRYPTION=$(bll-jwks-encryption),BLL_JWKS_SIGNATURE=$(bll-jwks-signature)
    
    
  - name: INT-NE
    retentionPolicy:
      releasesToKeep: 10
    variables:
      BLL_LOG_LEVEL:
        value: DEBUG
    variableGroups:
    - Config INT
    - Config INT-NE
    deployPhases:
    - name: Agent phase
      deploymentInput:
        queueId: 164
      workflowTasks:
      - taskId: 1e244d32-2dd4-4165-96fb-b7441ca9331e
        version: 1.*
        name: 'Azure Key Vault: webfoundation-int-akv'
        definitionType: task
        inputs:
          ConnectedServiceName: 6714e6c3-6518-4050-90ec-ed7288c13b3a
          KeyVaultName: webfoundation-int-akv
          SecretsFilter: "*"
      
      - taskId: 76a92167-7c70-4b54-ba35-13d5819c9b1e
        version: 2.*
        name: 'Task group: K8S Deploy V3 bll-contact'
        definitionType: metaTask
        inputs:
          AksCluster: "$(AKS_CLUSTER)"
          AzureResourceGroup: "$(AZURE_RESOURCE_GROUP)"
          AzureSubscription: 6714e6c3-6518-4050-90ec-ed7288c13b3a
          HelmArtifact: ''
          KubernetesDeploymentName: bll-contact
          KubernetesNamespace: "$(K8S_NAMESPACE)"
          KubernetesObjectType: ''
          SecretValues: BLL_JWKS_ENCRYPTION=$(bll-jwks-encryption),BLL_JWKS_SIGNATURE=$(bll-jwks-signature)
    
    
  - name: ACC-WE
    retentionPolicy:
      releasesToKeep: 10
    variables:
      BLL_LOG_LEVEL:
        value: DEBUG
    variableGroups:
    - Config INT
    - Config INT-WE
    deployPhases:
    - name: Agent phase
      deploymentInput:
        queueId: 165
      workflowTasks:
      - taskId: 1e244d32-2dd4-4165-96fb-b7441ca9331e
        version: 1.*
        name: 'Azure Key Vault: webfoundation-acc-akv'
        definitionType: task
        inputs:
          ConnectedServiceName: 6714e6c3-6518-4050-90ec-ed7288c13b3a
          KeyVaultName: webfoundation-acc-akv
          SecretsFilter: "*"
      
      - taskId: 76a92167-7c70-4b54-ba35-13d5819c9b1e
        version: 2.*
        name: 'Task group: K8S Deploy V3 bll-contact'
        definitionType: metaTask
        inputs:
          AksCluster: "$(AKS_CLUSTER)"
          AzureResourceGroup: "$(AZURE_RESOURCE_GROUP)"
          AzureSubscription: 6714e6c3-6518-4050-90ec-ed7288c13b3a
          HelmArtifact: ''
          KubernetesDeploymentName: bll-contact
          KubernetesNamespace: "$(K8S_NAMESPACE)"
          KubernetesObjectType: ''
          SecretValues: BLL_JWKS_ENCRYPTION=$(bll-jwks-encryption),BLL_JWKS_SIGNATURE=$(bll-jwks-signature)
    preDeployApprovals:
      approvals:
      - approver:
          id: c48d7901-feca-403b-b698-cf99c6e7d602
          isContainer: true
      approvalOptions:
        releaseCreatorCanBeApprover: true
    
  - name: ACC-NE
    retentionPolicy:
      releasesToKeep: 10
    variableGroups:
    - Config INT
    - Config INT-NE
    deployPhases:
    - name: Agent phase
      deploymentInput:
        queueId: 164
      workflowTasks:
      - taskId: 1e244d32-2dd4-4165-96fb-b7441ca9331e
        version: 1.*
        name: 'Azure Key Vault: webfoundation-acc-akv'
        definitionType: task
        inputs:
          ConnectedServiceName: 6714e6c3-6518-4050-90ec-ed7288c13b3a
          KeyVaultName: webfoundation-acc-akv
          SecretsFilter: "*"
      
      - taskId: 76a92167-7c70-4b54-ba35-13d5819c9b1e
        version: 2.*
        name: 'Task group: K8S Deploy V3 bll-contact'
        definitionType: metaTask
        inputs:
          AksCluster: "$(AKS_CLUSTER)"
          AzureResourceGroup: "$(AZURE_RESOURCE_GROUP)"
          AzureSubscription: 6714e6c3-6518-4050-90ec-ed7288c13b3a
          HelmArtifact: ''
          KubernetesDeploymentName: bll-contact
          KubernetesNamespace: "$(K8S_NAMESPACE)"
          KubernetesObjectType: ''
          SecretValues: BLL_JWKS_ENCRYPTION=$(bll-jwks-encryption),BLL_JWKS_SIGNATURE=$(bll-jwks-signature)
    preDeployApprovals:
      approvals:
      - approver:
          id: c48d7901-feca-403b-b698-cf99c6e7d602
          isContainer: true
      approvalOptions:
        releaseCreatorCanBeApprover: true
    
  - name: PRD-WE
    retentionPolicy:
      releasesToKeep: 10
    variableGroups:
    - Config INT
    - Config INT-WE
    deployPhases:
    - name: Agent phase
      deploymentInput:
        queueId: 165
      workflowTasks:
      - taskId: 1e244d32-2dd4-4165-96fb-b7441ca9331e
        version: 1.*
        name: 'Azure Key Vault: webfoundation-prd-akv'
        definitionType: task
        inputs:
          ConnectedServiceName: 6714e6c3-6518-4050-90ec-ed7288c13b3a
          KeyVaultName: webfoundation-prd-akv
          SecretsFilter: "*"
      
      - taskId: 76a92167-7c70-4b54-ba35-13d5819c9b1e
        version: 2.*
        name: 'Task group: K8S Deploy V3 bll-contact'
        definitionType: metaTask
        inputs:
          AksCluster: "$(AKS_CLUSTER)"
          AzureResourceGroup: "$(AZURE_RESOURCE_GROUP)"
          AzureSubscription: 6714e6c3-6518-4050-90ec-ed7288c13b3a
          HelmArtifact: ''
          KubernetesDeploymentName: bll-contact
          KubernetesNamespace: "$(K8S_NAMESPACE)"
          KubernetesObjectType: ''
          SecretValues: BLL_JWKS_ENCRYPTION=$(bll-jwks-encryption),BLL_JWKS_SIGNATURE=$(bll-jwks-signature)
    preDeployApprovals:
      approvals:
      - approver:
          id: e9a38fdf-a890-4227-909e-c438dc074464
          isContainer: true
      approvalOptions:
        releaseCreatorCanBeApprover: true
    
  - name: PRD-NE
    retentionPolicy:
      releasesToKeep: 10
    variableGroups:
    - Config INT
    - Config INT-NE
    deployPhases:
    - name: Agent phase
      deploymentInput:
        queueId: 164
      workflowTasks:
      - taskId: 1e244d32-2dd4-4165-96fb-b7441ca9331e
        version: 1.*
        name: 'Azure Key Vault: webfoundation-prd-akv'
        definitionType: task
        inputs:
          ConnectedServiceName: 6714e6c3-6518-4050-90ec-ed7288c13b3a
          KeyVaultName: webfoundation-prd-akv
          SecretsFilter: "*"
      
      - taskId: 76a92167-7c70-4b54-ba35-13d5819c9b1e
        version: 2.*
        name: 'Task group: K8S Deploy V3 bll-contact'
        definitionType: metaTask
        inputs:
          AksCluster: "$(AKS_CLUSTER)"
          AzureResourceGroup: "$(AZURE_RESOURCE_GROUP)"
          AzureSubscription: 6714e6c3-6518-4050-90ec-ed7288c13b3a
          HelmArtifact: ''
          KubernetesDeploymentName: bll-contact
          KubernetesNamespace: "$(K8S_NAMESPACE)"
          KubernetesObjectType: ''
          SecretValues: BLL_JWKS_ENCRYPTION=$(bll-jwks-encryption),BLL_JWKS_SIGNATURE=$(bll-jwks-signature)
    preDeployApprovals:
      approvals:
      - approver:
          id: e9a38fdf-a890-4227-909e-c438dc074464
          isContainer: true
      approvalOptions:
        releaseCreatorCanBeApprover: true
    
  artifacts:
  - type: Build
    alias: Test via API for bll-contact
    definitionReference:
      defaultVersionType:
        id: latestType
        name: Latest
      definition:
        name: Test via API for bll-contact
        path:  \Other\POC

